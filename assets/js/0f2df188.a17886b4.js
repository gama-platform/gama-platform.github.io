"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[41920],{22828:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>s,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>d});var t=i(74848),r=i(28453);const o={title:"Calling R from GAMA models"},l=void 0,a={id:"CallingR",title:"Calling R from GAMA models",description:"Introduction",source:"@site/versioned_docs/version-1.9.2/CallingR.md",sourceDirName:".",slug:"/CallingR",permalink:"/wiki/CallingR",draft:!1,unlisted:!1,editUrl:"https://github.com/gama-platform/gama/wiki/CallingR/_edit",tags:[],version:"1.9.2",frontMatter:{title:"Calling R from GAMA models"},sidebar:"main",previous:{title:"Using extensions",permalink:"/wiki/Using-extensions"},next:{title:"The Graphical Editor",permalink:"/wiki/G__GraphicalEditor"}},s={},d=[{value:"Introduction",id:"introduction",level:2},{value:"Installing R and rJava",id:"installing-r-and-rjava",level:2},{value:"Install R on your computer",id:"install-r-on-your-computer",level:3},{value:"install the rJava library in R",id:"install-the-rjava-library-in-r",level:3},{value:"In case of trouble",id:"in-case-of-trouble",level:4},{value:"For <strong>MacOSX</strong>",id:"for-macosx",level:5},{value:"For <strong>Linux</strong>",id:"for-linux",level:5},{value:"For <strong>Windows</strong>",id:"for-windows",level:5},{value:"Set the environment variable <code>R_HOME</code>",id:"set-the-environment-variable-r_home",level:3},{value:"<strong>On Windows</strong>",id:"on-windows",level:4},{value:"<strong>On Linux</strong>",id:"on-linux",level:4},{value:"<strong>On macOS</strong>",id:"on-macos",level:4},{value:"<strong>Recommended</strong>",id:"recommended",level:4},{value:"Updating the <code>Path</code> variable (Windows only)",id:"updating-the-path-variable-windows-only",level:3},{value:"Configuration in GAMA",id:"configuration-in-gama",level:2},{value:"Linking the R connector",id:"linking-the-r-connector",level:3},{value:"Installing the R plugin",id:"installing-the-r-plugin",level:3},{value:"Calling R from GAML",id:"calling-r-from-gaml",level:2},{value:"Before computation",id:"before-computation",level:3},{value:"Computation",id:"computation",level:3},{value:"Evaluate an R expression",id:"evaluate-an-r-expression",level:4},{value:"Evaluate an R script",id:"evaluate-an-r-script",level:4},{value:"Convert GAMA object to R object",id:"convert-gama-object-to-r-object",level:4},{value:"Convert a species to a dataframe",id:"convert-a-species-to-a-dataframe",level:4},{value:"Troubleshooting",id:"troubleshooting",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",h5:"h5",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,t.jsxs)(n.p,{children:["The R language is a powerful tool for statistical computing and graphics, and its community is very large in the world (See the ",(0,t.jsx)(n.a,{href:"http://www.r-project.org/",children:"website"}),"). Adding a support for the R language is one of our strong endeavors to accelerate many statistical and data mining tools integration into the GAMA platform."]}),"\n",(0,t.jsx)(n.h2,{id:"installing-r-and-rjava",children:"Installing R and rJava"}),"\n",(0,t.jsx)(n.h3,{id:"install-r-on-your-computer",children:"Install R on your computer"}),"\n",(0,t.jsxs)(n.p,{children:["Please refer to the R ",(0,t.jsx)(n.a,{href:"https://www.r-project.org/",children:"official website"}),", or to ",(0,t.jsx)(n.a,{href:"https://www.rstudio.com/",children:"RStudio"})," if you want in addition a nice IDE."]}),"\n",(0,t.jsx)(n.h3,{id:"install-the-rjava-library-in-r",children:"install the rJava library in R"}),"\n",(0,t.jsx)(n.p,{children:"In the R (RStudio) console, write:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'install.packages("rJava")\n'})}),"\n",(0,t.jsxs)(n.p,{children:["to install the library. To check that the install is correct, you load the library using ",(0,t.jsx)(n.code,{children:"library(rJava)"})," (in the R console). If no error message appears, it means the installation is correct."]}),"\n",(0,t.jsx)(n.h4,{id:"in-case-of-trouble",children:"In case of trouble"}),"\n",(0,t.jsxs)(n.h5,{id:"for-macosx",children:["For ",(0,t.jsx)(n.strong,{children:"MacOSX"})]}),"\n",(0,t.jsx)(n.p,{children:"in recent versions you should first write in a terminal:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"R CMD javareconf\nsudo ln -f -s $(/usr/libexec/java_home)/jre/lib/server/libjvm.dylib /usr/local/lib\n"})}),"\n",(0,t.jsxs)(n.h5,{id:"for-linux",children:["For ",(0,t.jsx)(n.strong,{children:"Linux"})]}),"\n",(0,t.jsxs)(n.p,{children:["make sure you have the ",(0,t.jsx)(n.code,{children:"default-jdk"})," and ",(0,t.jsx)(n.code,{children:"default-jre"})," packages installed and then execute the command ",(0,t.jsx)(n.code,{children:"sudo R CMD javareconf"})]}),"\n",(0,t.jsxs)(n.h5,{id:"for-windows",children:["For ",(0,t.jsx)(n.strong,{children:"Windows"})]}),"\n",(0,t.jsxs)(n.p,{children:["make sure you have a ",(0,t.jsx)(n.code,{children:"JAVA_HOME"})," and a ",(0,t.jsx)(n.code,{children:"CLASSPATH"})," environment variable setup, if not you need to create and set them, for example:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'JAVA_HOME="C:\\Program Files\\Java\\OpenJDK17\\"\nCLASSPATH="C:\\Program Files\\Java\\OpenJDK17\\bin\\"\n'})}),"\n",(0,t.jsxs)(n.h3,{id:"set-the-environment-variable-r_home",children:["Set the environment variable ",(0,t.jsx)(n.code,{children:"R_HOME"})]}),"\n",(0,t.jsx)(n.h4,{id:"on-windows",children:(0,t.jsx)(n.strong,{children:"On Windows"})}),"\n",(0,t.jsxs)(n.p,{children:["set the environment variables as follows.\n",(0,t.jsx)(n.code,{children:"R_HOME"})," is the root directory where we can find the ",(0,t.jsx)(n.code,{children:"library"})," folder in your ",(0,t.jsx)(n.code,{children:"R"})," installation, so it should look like this:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'R_HOME="C:\\Program Files\\R\\R-4.2.2\\" \n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"R_PATH"})," should point to the folder containing your ",(0,t.jsx)(n.code,{children:"R"})," interpreter, the variable should be set with something similar to this (adapting with your R version and R installation path):"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'R_PATH="C:\\Program Files\\R\\R-4.2.0\\bin\\x64" \n'})}),"\n",(0,t.jsx)(n.h4,{id:"on-linux",children:(0,t.jsx)(n.strong,{children:"On Linux"})}),"\n",(0,t.jsxs)(n.p,{children:["By default it should be ",(0,t.jsx)(n.code,{children:"/usr/lib/R"}),", you can thus just append the line ",(0,t.jsx)(n.code,{children:"R_HOME=/usr/lib/R"})," to your ",(0,t.jsx)(n.code,{children:"/etc/environment"})," file and reboot your computer"]}),"\n",(0,t.jsx)(n.h4,{id:"on-macos",children:(0,t.jsx)(n.strong,{children:"On macOS"})}),"\n",(0,t.jsxs)(n.p,{children:["You need to create (or update) the file ",(0,t.jsx)(n.code,{children:"environment.plist"})," in the folder: ",(0,t.jsx)(n.code,{children:"~/Library/LaunchAgents/"}),"\xa0(for the current user, note that this folder is a hidden folder) or in\xa0",(0,t.jsx)(n.code,{children:"/Library/LaunchAgents/"}),"\xa0(for all users)\nIt should look like:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n  <dict>\n    <key>Label</key>\n    <string>my.startup</string>\n    <key>ProgramArguments</key>\n    <array>\n      <string>sh</string>\n      <string>-c</string>\n      <string>\xa0launchctl setenv R_HOME /Library/Frameworks/R.framework/Resources/\xa0</string>\n    </array>\n    <key>RunAtLoad</key>\n    <true/>\n  </dict>\n</plist>\n'})}),"\n",(0,t.jsx)(n.h4,{id:"recommended",children:(0,t.jsx)(n.strong,{children:"Recommended"})}),"\n",(0,t.jsxs)(n.p,{children:["If the rJava library doesn't appear in the R library directory, copy the installed rJava library from where it was installed (with ",(0,t.jsx)(n.code,{children:'install.packages("rJava")'}),") to the ",(0,t.jsx)(n.code,{children:"library"})," folder in your ",(0,t.jsx)(n.code,{children:"R_HOME"}),"."]}),"\n",(0,t.jsxs)(n.h3,{id:"updating-the-path-variable-windows-only",children:["Updating the ",(0,t.jsx)(n.code,{children:"Path"})," variable (Windows only)"]}),"\n",(0,t.jsxs)(n.p,{children:["In addition, on Windows you also ",(0,t.jsx)(n.strong,{children:"need"})," to add to your ",(0,t.jsx)(n.code,{children:"Path"})," environment variable the path to your ",(0,t.jsx)(n.code,{children:"R"})," binaries, by default located in ",(0,t.jsx)(n.code,{children:"C:\\Program Files\\R\\R-4.2.2\\bin\\x64"})," for ",(0,t.jsx)(n.code,{children:"R-4.2.2 64bits"}),".\nThe ",(0,t.jsx)(n.code,{children:"Path"})," variable is a variable already created by Windows, so you just have to edit it to ",(0,t.jsx)(n.strong,{children:"add"})," a new path, no need to delete anything."]}),"\n",(0,t.jsx)(n.h2,{id:"configuration-in-gama",children:"Configuration in GAMA"}),"\n",(0,t.jsx)(n.h3,{id:"linking-the-r-connector",children:"Linking the R connector"}),"\n",(0,t.jsx)(n.p,{children:"From GAMA 1.9.0, you need to specify the path to the R connector library in the GAMA launching arguments.\nTo this purpose, you need to add to either:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["the ",(0,t.jsx)(n.code,{children:"GAMA.ini"})," file if you use the release version of GAMA"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"or"})," the launching configuration (if you use the source code version) the following line: (replace ",(0,t.jsx)(n.code,{children:"PATH_TO_R"})," by the path to R, i.e. the value in ",(0,t.jsx)(n.code,{children:"$R_HOME"}),"):"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"on macOS"}),":    ",(0,t.jsx)(n.code,{children:"-Djava.library.path=PATH_TO_R/library/rJava/jri/rlibjri.jnilib"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"on Windows"}),":  ",(0,t.jsx)(n.code,{children:"-Djava.library.path=PATH_TO_R\\library\\rJava\\jri\\"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"on Linux"}),":    ",(0,t.jsx)(n.code,{children:"-Djava.library.path=PATH/TO/JRI"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"As an example, under macOS, you need to add:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"-Djava.library.path=/Library/Frameworks/R.framework/Resources/library/rJava/jri/\n"})}),"\n",(0,t.jsxs)(n.p,{children:["On Windows and Linux, the jri library could be in a different location than the ",(0,t.jsx)(n.code,{children:"R_HOME"}),", for example on Linux by default it would be in:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"-Djava.library.path=/home/user_name/R/x86_64-pc-linux-gnu-library/3.6/rJava/jri/\n"})}),"\n",(0,t.jsxs)(n.p,{children:["On Windows it can be located in the user's ",(0,t.jsx)(n.code,{children:"AppData\\local"})," or in ",(0,t.jsx)(n.code,{children:"Documents\\R"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"installing-the-r-plugin",children:"Installing the R plugin"}),"\n",(0,t.jsxs)(n.p,{children:['Next you need to install the R plugin from Gama. To do it, select "Install new plugins..." in the "Help" menu of Gama.\nIn the ',(0,t.jsx)(n.code,{children:"Work with"}),' drop down select the repository ending with "experimental/" followed by your Gama version.\nOnce done, you need to select the plugin ',(0,t.jsx)(n.code,{children:"rJava"}),", click on ",(0,t.jsx)(n.code,{children:"next"})," and then ",(0,t.jsx)(n.code,{children:"finish"}),".\n",(0,t.jsx)(n.img,{src:"https://user-images.githubusercontent.com/6374469/167291685-9e350a5c-9de6-443f-842d-276deb3a785e.png",alt:"image"})]}),"\n",(0,t.jsxs)(n.p,{children:['After this, you could be asked to "trust" the plugin, simply select the first line and click on ',(0,t.jsx)(n.code,{children:"Trust selected"}),"\n",(0,t.jsx)(n.img,{src:"https://user-images.githubusercontent.com/6374469/167291718-5c4083c6-cade-45cc-b6a6-d0524504e042.png",alt:"image"})]}),"\n",(0,t.jsxs)(n.p,{children:["Finally, you will be asked to restart Gama, click on ",(0,t.jsx)(n.code,{children:"Restart now"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["For more details, readers can refer to ",(0,t.jsx)(n.a,{href:"InstallingPlugins",children:"the page dedicated to the installation of additional plugins"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"calling-r-from-gaml",children:"Calling R from GAML"}),"\n",(0,t.jsx)(n.h3,{id:"before-computation",children:"Before computation"}),"\n",(0,t.jsxs)(n.p,{children:["Any agent aiming at using R for some computation needs to be provided with the ",(0,t.jsx)(n.code,{children:"RSkill"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Before calling any computation, this agent needs to start a connection with the R software."}),"\n",(0,t.jsxs)(n.p,{children:["As an example, if we want  that the ",(0,t.jsx)(n.code,{children:"global"})," agent can use R, we need to have the following minimal model:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"global skills: [RSkill] {\n   init {\n      do startR;\n   }\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"computation",children:"Computation"}),"\n",(0,t.jsx)(n.h4,{id:"evaluate-an-r-expression",children:"Evaluate an R expression"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"R_eval"})," operator can be used to evaluate any R expression. It can  also be used to initialize a variable or call any function. It can return any data type  (depending on the R output).\nAs in an R session, the various evaluations are dependent on the previous ones."]}),"\n",(0,t.jsx)(n.p,{children:"Example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'global skills: [RSkill] {\n\t\n\tinit{\n\t\tdo startR;\n\t\t\n\t\twrite R_eval("x<-1");\n\t\twrite R_eval("rnorm(50,0,5)");\n\t}\n\n}\n'})}),"\n",(0,t.jsx)(n.h4,{id:"evaluate-an-r-script",children:"Evaluate an R script"}),"\n",(0,t.jsx)(n.p,{children:"To evaluate an R script, stored in a (text) file, open the file and execute each of its lines."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'global skills:[RSkill]{\n\tfile Rcode <- text_file("../includes/rScript.txt");\n\t\tinit{\n\t\tdo startR;\n\t\t// Loop that takes each line of the R script and execute it.\n\t \tloop s over: Rcode.contents{\n\t\t\tunknown a <- R_eval(s);\n\t\t\twrite "R>"+s;\n\t\t\twrite a;\n\t\t}\n\t}\n}\n'})}),"\n",(0,t.jsx)(n.h4,{id:"convert-gama-object-to-r-object",children:"Convert GAMA object to R object"}),"\n",(0,t.jsxs)(n.p,{children:["To use GAMA complex objects into R functions, we need to transform them using the ",(0,t.jsx)(n.code,{children:"to_R_data"})," operator: it transforms any GAMA object into a R object."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'global skills:[RSkill] {\n\tinit {\n\t\tdo startR();\n\t\t\n\t\tstring s2 <- "s2";\n\t\tlist<int> numlist <- [1,2,3,4]; \n  \t\twrite R_eval("numlist = " + to_R_data(numlist));\n\t}\n}\n'})}),"\n",(0,t.jsx)(n.h4,{id:"convert-a-species-to-a-dataframe",children:"Convert a species to a dataframe"}),"\n",(0,t.jsxs)(n.p,{children:["Dataframe is a powerful R data type allowing to ease data manipulation...\nDataframe wan of course be defined at hand using R commands. But GAML provides the ",(0,t.jsx)(n.code,{children:"to_R_dataframe"})," operator to directly transform a species of agents into a dataframe for future analysis."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'global skills: [RSkill] {\n\t\n\tinit{\n\t\tdo startR();\n\t\t\n\t\tcreate people number: 10;\n\t\t\n\t\tdo R_eval("df<-" + to_R_dataframe(people));\n\t\twrite R_eval("df");\n\t\twrite R_eval("df$flipCoin");\t\n\t}\n}\nspecies people {\n\tbool flipCoin <- flip(0.5);\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsxs)(n.p,{children:["It is possible that after installing everything, Gama works normally but crashes every time you try to use the skill ",(0,t.jsx)(n.code,{children:"RSkill"})," without any error message. If that's the case, the problem is certainly that Gama is unable to load the ",(0,t.jsx)(n.code,{children:"jri"})," library or its dependencies (other R packages). Make sure that the path you wrote in the ",(0,t.jsx)(n.code,{children:".ini"})," file is correct and that every environment variable is set with proper values."]}),"\n",(0,t.jsxs)(n.p,{children:["Also on windows, check that the ",(0,t.jsx)(n.code,{children:"Path"})," variable contains the path to your ",(0,t.jsx)(n.code,{children:"R"})," installation."]}),"\n",(0,t.jsxs)(n.p,{children:["If after checking everything the problem is still there, you can try copying the ",(0,t.jsx)(n.code,{children:".dll"})," files at the ",(0,t.jsx)(n.code,{children:"R_PATH"})," location and the ",(0,t.jsx)(n.code,{children:"jri.dll"})," and paste them into your ",(0,t.jsx)(n.code,{children:"JAVA_PATH"})," directory (the ",(0,t.jsx)(n.code,{children:"bin"})," folder of your jdk)."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>a});var t=i(96540);const r={},o=t.createContext(r);function l(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);