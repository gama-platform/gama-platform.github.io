<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-1.9.0 plugin-docs plugin-id-default docs-doc-id-Diffusion">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Implementing diffusion | GAMA Platform</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://gama-platform.org/resources/images/general/GamaPlatform.png"><meta data-rh="true" name="twitter:image" content="https://gama-platform.org/resources/images/general/GamaPlatform.png"><meta data-rh="true" property="og:url" content="https://gama-platform.org/wiki/Diffusion"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="1.9.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-1.9.0"><meta data-rh="true" name="docsearch:version" content="1.9.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-1.9.0"><meta data-rh="true" property="og:title" content="Implementing diffusion | GAMA Platform"><meta data-rh="true" name="description" content="GAMA provides you the possibility to represent and simulate the diffusion of a variable through a grid topology."><meta data-rh="true" property="og:description" content="GAMA provides you the possibility to represent and simulate the diffusion of a variable through a grid topology."><link data-rh="true" rel="icon" href="/img/gama-logo.png"><link data-rh="true" rel="canonical" href="https://gama-platform.org/wiki/Diffusion"><link data-rh="true" rel="alternate" href="https://gama-platform.org/wiki/Diffusion" hreflang="en"><link data-rh="true" rel="alternate" href="https://gama-platform.org/wiki/Diffusion" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://MWUOLTL2EG-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="GAMA Platform RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="GAMA Platform Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="GAMA Platform" href="/opensearch.xml">


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.1.1/css/all.css">
<script src="/js/blogFacebook-iFrame.js" async></script><link rel="stylesheet" href="/assets/css/styles.5385e3e4.css">
<link rel="preload" href="/assets/js/runtime~main.f853084d.js" as="script">
<link rel="preload" href="/assets/js/main.4e25c91d.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(e){}return e}()||function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/gama-logo.png" alt="" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/gama-logo.png" alt="" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">GAMA Platform</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/wiki/Home">Documentation</a><a class="navbar__item navbar__link" href="/wiki/Tutorials">Tutorials</a><a class="navbar__item navbar__link" href="/download">Download</a><a class="navbar__item navbar__link" href="/wiki/Contribute">Contribute</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/faq">FAQ</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/wiki/Tutorials">1.9.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/wiki/next/Diffusion">ðŸš§ 1.9.1 ðŸš§</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/wiki/Diffusion">1.9.0</a></li><li><a class="dropdown__link" href="/wiki/1.8.2-RC2/Diffusion">1.8.2-RC2</a></li><li><a class="dropdown__link" href="/wiki/1.8.1/Diffusion">1.8.1</a></li></ul></div><a href="https://github.com/gama-platform/gama" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><i class="fab fa-github" style="font-size: 24px;"></i></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/wiki/Home">Home</a><button aria-label="Toggle the collapsible sidebar category &#x27;Home&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/wiki/PlatformDocumentation">Platform</a><button aria-label="Toggle the collapsible sidebar category &#x27;Platform&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/wiki/LearnGAMLStepByStep">Learn GAML step by step</a><button aria-label="Toggle the collapsible sidebar category &#x27;Learn GAML step by step&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/wiki/Recipes">Recipes</a><button aria-label="Toggle the collapsible sidebar category &#x27;Recipes&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/wiki/ManipulateOSMDatas">Manipulate OSM Datas</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/wiki/Diffusion">Implementing diffusion</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/wiki/UsingDatabase">Using Database Access</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/wiki/UsingFIPAACL">Using FIPA ACL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/wiki/Using-BEN-simple-bdi">Using BEN (simple_bdi)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/wiki/UsingDrivingSkill">Advanced Driving Skill</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/wiki/ManipulateDates">Manipulate Dates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/wiki/ManipulateLight">Implementing light</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/wiki/Comodel">Using Comodel</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/wiki/Save-and-restore-simulations">Save and Restore simulations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/wiki/UsingNetwork">Using network</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/wiki/Headless-mode-for-dummies">Headless mode for dummies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/wiki/Writing_Tests">Writing Unit Tests in GAML</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/wiki/Using-extensions">Going further with extensions</a><button aria-label="Toggle the collapsible sidebar category &#x27;Going further with extensions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/wiki/GamlReference">GAML References</a><button aria-label="Toggle the collapsible sidebar category &#x27;GAML References&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/wiki/developingGAMA">Developing GAMA</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developing GAMA&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/wiki/Projects">Projects using GAMA</a><button aria-label="Toggle the collapsible sidebar category &#x27;Projects using GAMA&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/wiki/Recipes"><span itemprop="name">Recipes</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Implementing diffusion</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 1.9.0</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Implementing diffusion</h1></header><p>GAMA provides you the possibility to represent and simulate the diffusion of a variable through a grid topology. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="index">Index<a href="#index" class="hash-link" aria-label="Direct link to Index" title="Direct link to Index">â€‹</a></h2><ul><li><a href="#diffuse-statement">Diffuse statement</a></li><li><a href="#diffusion-with-matrix">Diffusion with matrix</a><ul><li><a href="#diffusion-matrix">Diffusion matrix</a></li><li><a href="#gradient-matrix">Gradient matrix</a></li><li><a href="#compute-multiple-propagations-at-the-same-step">Compute multiple propagations at the same step</a></li><li><a href="#execution-several-diffusion-matrix">Executing several diffusion matrix</a></li></ul></li><li><a href="#diffusion-with-parameters">Diffusion with parameters</a></li><li><a href="#computation-methods">Computation methods</a><ul><li><a href="#convolution">Convolution</a></li><li><a href="#dot-product">Dot Product</a></li></ul></li><li><a href="#using-mask">Use mask</a><ul><li><a href="#generalities">Generalities</a></li><li><a href="#tips">Tips</a></li></ul></li><li><a href="#pseudo-code">Pseudo code</a></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="diffuse-statement">Diffuse statement<a href="#diffuse-statement" class="hash-link" aria-label="Direct link to Diffuse statement" title="Direct link to Diffuse statement">â€‹</a></h2><p>The statement to use for the diffusion is <code>diffuse</code>. It has to be used in a <code>grid</code> species. The <code>diffuse</code> uses the following facets:</p><ul><li><strong><code>var</code></strong> (an identifier), (omissible) : the variable to be diffused  </li><li><strong><code>on</code></strong> (any type in <!-- -->[container, species]<!-- -->): the list of agents (in general cells of a grid), on which the diffusion will occur</li><li><code>avoid_mask</code> (boolean): if true, the value will not be diffused in the masked cells, but will be restituted to the neighboring cells, multiplied by the variation value (no signal loss). If false, the value will be diffused in the masked cells, but masked cells won&#x27;t diffuse the value afterward (loss of signal). (default value : false)</li><li><code>cycle_length</code> (int): the number of diffusion operation applied in one simulation step</li><li><code>mask</code> (matrix): a matrix masking the diffusion (matrix created from an image for example). The cells corresponding to the values smaller than &quot;-1&quot; in the mask matrix will not diffuse, and the other will diffuse.</li><li><code>matrix</code> (matrix): the diffusion matrix (&quot;kernel&quot; or &quot;filter&quot; in image processing). Can have any size, as long as dimensions are odd values.</li><li><code>method</code> (an identifier), takes values in: {convolution, dot_product}: the diffusion method</li><li><code>min</code> (float): if a value is smaller than this value, it will not be diffused. By default, this value is equal to 0.0. This value cannot be smaller than 0.</li><li><code>propagation</code> (a label), takes values in {diffusion, gradient} represents both the way the signal is propagated and the way to treat multiple propagations of the same signal occurring at once from different places. If propagation equals &#x27;diffusion&#x27;, the intensity of a signal is shared between its neighbors with respect to &#x27;proportion&#x27;, &#x27;variation&#x27; and the number of neighbors of the environment places (4, 6 or 8). I.e., for a given signal S propagated from place P, the value transmitted to its N neighbors is S&#x27; = (S / N / proportion) - variation. The intensity of S is then diminished by S <code>*</code> proportion on P. In diffusion, the different signals of the same name see their intensities added to each other on each place. If propagation equals &#x27;gradient&#x27;, the original intensity is not modified, and each neighbor receives the intensity: S / proportion - variation. If multiple propagations occur at once, only the maximum intensity is kept on each place. If &#x27;propagation&#x27; is not defined, it is assumed that it is equal to &#x27;diffusion&#x27;.</li><li><code>proportion</code> (float): a diffusion rate</li><li><code>radius</code> (int): a diffusion radius (in number of cells from the center)</li><li><code>variation</code> (float): an absolute value to decrease at each neighbor </li></ul><p>To write a diffusion, you first have to declare a grid and declare a special attribute for the diffusion. You will then have to write the <code>diffuse</code> statement in another scope (such as the <code>global</code> scope for instance), which will permit the values to be diffused at each step. There, you will specify which variable you want to diffuse (through the <strong><code>var</code></strong> facet), on which species or list of agents you want the diffusion (through the <strong><code>on</code></strong> facet), and how you want this value to be diffused (through all the other facets, we will see how it works <a href="#diffusion-with-matrix">with matrix</a> and <a href="#diffusion-with-parameters">with special parameters</a> just after).</p><p>Here is the template of code we will use for the next following part of this page:</p><div class="language-gaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#282A36;--prism-background-color:#FFFFFF"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#282A36"><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">global</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token type_statement" style="color:rgb(127,0,85);font-style:bold">int </span><span class="token variable" style="color:rgb(28,125,180)">size</span><span class="token plain"> &lt;- </span><span class="token number" style="color:rgb(125,125,125)">64</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(63,127,95)">// the size has to be a power of 2.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token variable" style="color:rgb(28,125,180)">cells</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">selected_cells</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token comment" style="color:rgb(63,127,95)">// Initialize the emitter cell as the cell at the center of the word</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">init</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token variable" style="color:rgb(28,125,180)">selected_cells</span><span class="token plain"> &lt;- </span><span class="token variable" style="color:rgb(28,125,180)">location</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">as</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">cells</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token comment" style="color:rgb(63,127,95)">// Affecting &quot;1&quot; to each step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">reflex</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">new_Value</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">ask</span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">selected_cells</span><span class="token punctuation">)</span><span class="token plain">{</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        </span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token plain"> &lt;- </span><span class="token number" style="color:rgb(125,125,125)">1.0</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    }   </span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">reflex</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">diff</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token comment" style="color:rgb(63,127,95)">// Declare a diffusion on the grid &quot;cells&quot; and on &quot;quick_cells&quot;. </span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        </span><span class="token comment" style="color:rgb(63,127,95)">// The diffusion declared on &quot;quick_cells&quot; will make 10 computations at each step to accelerate the process. </span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token comment" style="color:rgb(63,127,95)">// The value of the diffusion will be store in the new variable &quot;phero&quot; of the cell.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffuse</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">var:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">on:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">cells</span><span class="token plain"> </span><span class="token comment" style="color:rgb(63,127,95)">/*HERE WRITE DOWN THE DIFFUSION PROPERTIES*/</span><span class="token punctuation">;</span><span class="token plain">          </span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">}</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain"></span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">grid</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">cells</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">height:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">size</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">width:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">size</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token comment" style="color:rgb(63,127,95)">// &quot;phero&quot; is the variable storing the value of the diffusion</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token type_statement" style="color:rgb(127,0,85);font-style:bold">float </span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token plain">  &lt;- </span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token comment" style="color:rgb(63,127,95)">// The color of the cell is linked to the value of &quot;phero&quot;.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token type_statement" style="color:rgb(127,0,85);font-style:bold">rgb </span><span class="token variable" style="color:rgb(28,125,180)">color</span><span class="token plain"> &lt;- </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">hsb</span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1.0</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1.0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">update:</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">hsb</span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1.0</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">}</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain"></span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">experiment</span><span class="token plain"> </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffusion</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">type:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">gui</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">output</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">display</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">a</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">type:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">opengl</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        </span><span class="token comment" style="color:rgb(63,127,95)">// Display the grid with elevation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">grid</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">cells</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">elevation:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token plain"> * </span><span class="token number" style="color:rgb(125,125,125)">10</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">triangulation:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(125,125,125)">true</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This model will simulate a diffusion through a grid at each step, affecting 1 to the center cell diffusing variable value. The diffusion will be seen during the simulation through a color code, and through the elevation of the cell.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="diffusion-with-matrix">Diffusion with matrix<a href="#diffusion-with-matrix" class="hash-link" aria-label="Direct link to Diffusion with matrix" title="Direct link to Diffusion with matrix">â€‹</a></h2><p>A first way of specifying the behavior of your diffusion is using diffusion matrix. A diffusion matrix is a 2-dimension matrix <code>[n][m]</code> with <code>float</code> values, where both <code>n</code> and <code>m</code> have to be <strong>odd values</strong>. The most often, diffusion matrices are square matrices, but you can also declare a rectangular matrix.</p><p>Example of matrix:</p><div class="language-gaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#282A36;--prism-background-color:#FFFFFF"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#282A36"><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token plain">&lt;</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">float</span><span class="token plain">&gt; </span><span class="token variable" style="color:rgb(28,125,180)">mat_diff</span><span class="token plain"> &lt;- </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token punctuation">(</span><span class="token plain">[</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the <code>diffuse</code> statement, you then have to specify the matrix of diffusion you want in the facet <code>matrix</code>.</p><div class="language-gaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#282A36;--prism-background-color:#FFFFFF"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#282A36"><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffuse</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">var:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">on:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">cells</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">matrix:</span><span class="token variable" style="color:rgb(28,125,180)">mat_diff</span><span class="token punctuation">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Using the facet <code>propagation</code>, you can specify if you want the value to be propagated as a <em>diffusion</em> or as a <em>gradient</em>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="diffusion-matrix">Diffusion matrix<a href="#diffusion-matrix" class="hash-link" aria-label="Direct link to Diffusion matrix" title="Direct link to Diffusion matrix">â€‹</a></h3><p>A <em>diffusion</em> (the default value of the facet <code>propagation</code>) will spread the values to the neighbors&#x27; cells according to the diffusion matrix, and all those values will be added together, as it is the case in the following example:</p><p><img loading="lazy" alt="Illustration of the computation under a diffusion propagation." src="/assets/images/diffusion_computation-7455556d0ff6858746423b27ba655cdd.png" width="2395" height="889" class="img_ev3q"></p><p>Note that the sum of all the values diffused at the next step is equal to the sum of the values that will be diffused multiply by the sum of the values of the diffusion matrix. That means that if the sum of the values of your diffusion matrix is larger than 1, the values will increase exponentially at each step. The sum of the value of a diffusion matrix is usually equal to 1.</p><p>Here are some matrix examples you can use, played with the template model:</p><p><img loading="lazy" alt="Examples of uniform diffusions with one and several sources." src="/assets/images/uniform_diffusion-b45c8731de19205796aa9a9eda7ac777.png" width="2105" height="889" class="img_ev3q"></p><p><img loading="lazy" alt="Examples of anisotropic diffusions (with and with torus environment)." src="/assets/images/anisotropic_diffusion-697041c28d9e833f7a1169497787a123.png" width="2149" height="889" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gradient-matrix">Gradient matrix<a href="#gradient-matrix" class="hash-link" aria-label="Direct link to Gradient matrix" title="Direct link to Gradient matrix">â€‹</a></h3><p>A <code>gradient</code> (use facet : <code>propagation:gradient</code>) is another type of propagation. This time, only the larger value diffused will be chosen as the new one.</p><p><img loading="lazy" alt="Illustration of the computation under a gradient propagation." src="/assets/images/gradient_computation-3cc65350050f4ecbb11b2ca695abb40c.png" width="2395" height="889" class="img_ev3q"></p><p>Note that unlike the <em>diffusion</em> propagation, the sum of your matrix can be greater than 1 (and it is the case, most often !).</p><p>Here are some matrix examples with gradient propagation:</p><p><img loading="lazy" alt="Examples of gradient diffusions with one and several sources." src="/assets/images/uniform_gradient-231bbe6007c499e5b5d294ff14d73739.png" width="2509" height="967" class="img_ev3q"></p><p><img loading="lazy" alt="Examples of irregular gradient diffusions." src="/assets/images/irregular_gradient-ad875670b8c3ab62b617f33675b8aa04.png" width="1837" height="693" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="compute-multiple-propagations-at-the-same-step">Compute multiple propagations at the same step<a href="#compute-multiple-propagations-at-the-same-step" class="hash-link" aria-label="Direct link to Compute multiple propagations at the same step" title="Direct link to Compute multiple propagations at the same step">â€‹</a></h3><p>You can compute several times the propagation you want by using the facet <code>cycle_length</code>. GAMA will compute for you the corresponding new matrix and will apply it.</p><p><img loading="lazy" alt="Example of computation with a cycle length of 2." src="/assets/images/cycle_length-99434c002786e79fbc23c17f4252c793.png" width="1563" height="528" class="img_ev3q"></p><p>Writing those two things are exactly equivalent (for diffusion):</p><div class="language-gaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#282A36;--prism-background-color:#FFFFFF"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#282A36"><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token plain">&lt;</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">float</span><span class="token plain">&gt; </span><span class="token variable" style="color:rgb(28,125,180)">mat_diff</span><span class="token plain"> &lt;- </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token punctuation">(</span><span class="token plain">[</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">3</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">4</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">6</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">4</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">3</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">6</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">6</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">3</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">4</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">6</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">4</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">3</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token plain">]]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain"></span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">reflex</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">diff</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffuse</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">var:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">on:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">cells</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">matrix:</span><span class="token variable" style="color:rgb(28,125,180)">mat_diff</span><span class="token punctuation">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and</p><div class="language-gaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#282A36;--prism-background-color:#FFFFFF"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#282A36"><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token plain">&lt;</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">float</span><span class="token plain">&gt; </span><span class="token variable" style="color:rgb(28,125,180)">mat_diff</span><span class="token plain"> &lt;- </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token punctuation">(</span><span class="token plain">[</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain"></span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">reflex</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">diff</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffuse</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">var:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">on:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">cells</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">matrix:</span><span class="token variable" style="color:rgb(28,125,180)">mat_diff</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">cycle_length:</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token punctuation">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="executing-several-diffusion-matrix">Executing several diffusion matrix<a href="#executing-several-diffusion-matrix" class="hash-link" aria-label="Direct link to Executing several diffusion matrix" title="Direct link to Executing several diffusion matrix">â€‹</a></h3><p>If you execute several times the statement <code>diffuse</code> with different matrix on the same variable, their values will be added (and centered if their dimensions are not equal).</p><p>Thus, the following 3 matrices will be combined to create one unique matrix:</p><p><img loading="lazy" alt="Example of matrix combinations." src="/assets/images/addition_matrix-158c501d3c7d3601a4ba74f0157ea2c1.png" width="1873" height="867" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="diffusion-with-parameters">Diffusion with parameters<a href="#diffusion-with-parameters" class="hash-link" aria-label="Direct link to Diffusion with parameters" title="Direct link to Diffusion with parameters">â€‹</a></h2><p>Sometimes writing diffusion matrix is not exactly what you want, and you may prefer to just give some parameters to compute the correct diffusion matrix. You can use the following facets in order to do that: <code>propagation</code>, <code>variation</code> and <code>radius</code>.</p><p>Depending on which <code>propagation</code> you choose, and how many neighbors your grid has, the propagation matrix will be computed differently. The propagation matrix will have the size: range*2+1.</p><p>Let&#x27;s note <strong>P</strong> for the propagation value, <strong>V</strong> for the variation, <strong>R</strong> for the range and <strong>N</strong> for the number of neighbors.</p><ul><li><strong>With diffusion propagation</strong></li></ul><p>For diffusion propagation, we compute following the following steps:</p><p>(1) We determine the &quot;minimale&quot; matrix according to N (if N = 8, the matrix will be <code>[[P/9,P/9,P/9][P/9,1/9,P/9][P/9,P/9,P/9]]</code>. if N = 4, the matrix will be <code>[[0,P/5,0][P/5,1/5,P/5][0,P/5,0]]</code>).</p><p>(2) If R != 1, we propagate the matrix R times to obtain a <code>[2*R+1][2*R+1]</code> matrix (same computation as for <code>cycle_length</code>).</p><p>(3) If V != 0, we substract each value by V*DistanceFromCenter (DistanceFromCenter depends on N).</p><p>Ex with the default values (P=1, R=1, V=0, N=8):</p><ul><li><strong>With gradient propagation</strong></li></ul><p>The value of each cell will be equal to <strong>P/POW(N,DistanceFromCenter)-DistanceFromCenter*V</strong>. (DistanceFromCenter depends on N).</p><p>Ex with R=2, other parameters default values (R=2, P=1, V=0, N=8):</p><p><img loading="lazy" alt="resources/images/recipes/gradient_computation_from_parameters.png" src="/assets/images/gradient_computation_from_parameters-b59ef3482aaabd8968104d3ecb901d9b.png" width="1361" height="981" class="img_ev3q"></p><p>Note that if you declared a diffusion matrix, you cannot use those 3 facets (it will raise a warning). Note also that if you use parameters, you will only have a uniform matrix.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="computation-methods">Computation methods<a href="#computation-methods" class="hash-link" aria-label="Direct link to Computation methods" title="Direct link to Computation methods">â€‹</a></h2><p>You can compute the output matrix using two computation methods by using the facet <code>method</code> : the dot product and the convolution. Note that the result of those two methods is exactly the same (except if you use the <code>avoid_mask</code> facet, the results can be slightly different between the two computations).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="convolution">Convolution<a href="#convolution" class="hash-link" aria-label="Direct link to Convolution" title="Direct link to Convolution">â€‹</a></h3><p><code>convolution</code> is the default computation method for diffusion. For every output cells, we will multiply the input values and the flipped kernel together, as shown in the following image :</p><p><img loading="lazy" alt="Illustration of convolution product computation." src="/assets/images/convolution-0ecbc2472baf2c18b31451f74ce37e3c.png" width="661" height="369" class="img_ev3q"></p><p>Pseudo-code (<code>k</code> the kernel, <code>x</code> the input matrix, <code>y</code> the output matrix) :</p><div class="language-gaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#282A36;--prism-background-color:#FFFFFF"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#282A36"><span class="token variable" style="color:rgb(28,125,180)">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">i</span><span class="token plain"> = </span><span class="token number" style="color:rgb(125,125,125)">0</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">i</span><span class="token plain"> &lt; </span><span class="token variable" style="color:rgb(28,125,180)">y</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">nbRows</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">i</span><span class="token plain">++</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">  </span><span class="token variable" style="color:rgb(28,125,180)">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">j</span><span class="token plain"> = </span><span class="token number" style="color:rgb(125,125,125)">0</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">j</span><span class="token plain"> &lt; </span><span class="token variable" style="color:rgb(28,125,180)">y</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">nbCols</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">j</span><span class="token plain">++</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token variable" style="color:rgb(28,125,180)">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">m</span><span class="token plain"> = </span><span class="token number" style="color:rgb(125,125,125)">0</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">m</span><span class="token plain"> &lt; </span><span class="token variable" style="color:rgb(28,125,180)">k</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">nbRows</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">m</span><span class="token plain">++</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">      </span><span class="token variable" style="color:rgb(28,125,180)">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">n</span><span class="token plain"> = </span><span class="token number" style="color:rgb(125,125,125)">0</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">n</span><span class="token plain"> &lt; </span><span class="token variable" style="color:rgb(28,125,180)">k</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">nbCols</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">n</span><span class="token plain">++</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        </span><span class="token variable" style="color:rgb(28,125,180)">y</span><span class="token plain">[</span><span class="token variable" style="color:rgb(28,125,180)">i</span><span class="token punctuation">,</span><span class="token variable" style="color:rgb(28,125,180)">j</span><span class="token plain">] += </span><span class="token variable" style="color:rgb(28,125,180)">k</span><span class="token plain">[</span><span class="token variable" style="color:rgb(28,125,180)">k</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">nbRows</span><span class="token plain"> - </span><span class="token variable" style="color:rgb(28,125,180)">m</span><span class="token plain"> - </span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">k</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">nbCols</span><span class="token plain"> - </span><span class="token variable" style="color:rgb(28,125,180)">n</span><span class="token plain"> - </span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">] </span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">            * </span><span class="token variable" style="color:rgb(28,125,180)">x</span><span class="token plain">[</span><span class="token variable" style="color:rgb(28,125,180)">i</span><span class="token plain"> - </span><span class="token variable" style="color:rgb(28,125,180)">k</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">nbRows</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain"> + </span><span class="token variable" style="color:rgb(28,125,180)">m</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">j</span><span class="token plain"> - </span><span class="token variable" style="color:rgb(28,125,180)">k</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">nbCols</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain"> + </span><span class="token variable" style="color:rgb(28,125,180)">n</span><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dot-product">Dot Product<a href="#dot-product" class="hash-link" aria-label="Direct link to Dot Product" title="Direct link to Dot Product">â€‹</a></h3><p><code>dot_product</code> method will compute the matrix using a simple dot product between the matrix. For every input cells, we multiply the cell by the kernel matrix, as shown in the following image :</p><p><img loading="lazy" alt="Illustration of dat product computation." src="/assets/images/dot_product-582f0d67111e9958fe8b191abbbf12bd.png" width="674" height="349" class="img_ev3q"></p><p>Pseudo-code (<code>k</code> the kernel, <code>x</code> the input matrix, <code>y</code> the output matrix) :</p><div class="language-gaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#282A36;--prism-background-color:#FFFFFF"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#282A36"><span class="token variable" style="color:rgb(28,125,180)">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">i</span><span class="token plain"> = </span><span class="token number" style="color:rgb(125,125,125)">0</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">i</span><span class="token plain"> &lt; </span><span class="token variable" style="color:rgb(28,125,180)">y</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">nbRows</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">i</span><span class="token plain">++</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">  </span><span class="token variable" style="color:rgb(28,125,180)">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">j</span><span class="token plain"> = </span><span class="token number" style="color:rgb(125,125,125)">0</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">j</span><span class="token plain"> &lt; </span><span class="token variable" style="color:rgb(28,125,180)">y</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">nbCols</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">j</span><span class="token plain">++</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token variable" style="color:rgb(28,125,180)">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">m</span><span class="token plain"> = </span><span class="token number" style="color:rgb(125,125,125)">0</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">m</span><span class="token plain"> &lt; </span><span class="token variable" style="color:rgb(28,125,180)">k</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">nbRows</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">m</span><span class="token plain">++</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">      </span><span class="token variable" style="color:rgb(28,125,180)">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">n</span><span class="token plain"> = </span><span class="token number" style="color:rgb(125,125,125)">0</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">n</span><span class="token plain"> &lt; </span><span class="token variable" style="color:rgb(28,125,180)">k</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">nbCols</span><span class="token plain"> </span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">n</span><span class="token plain">++</span><span class="token punctuation">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        </span><span class="token variable" style="color:rgb(28,125,180)">y</span><span class="token plain">[</span><span class="token variable" style="color:rgb(28,125,180)">i</span><span class="token plain"> - </span><span class="token variable" style="color:rgb(28,125,180)">k</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">nbRows</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain"> + </span><span class="token variable" style="color:rgb(28,125,180)">m</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">j</span><span class="token plain"> - </span><span class="token variable" style="color:rgb(28,125,180)">k</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">nbCols</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain"> + </span><span class="token variable" style="color:rgb(28,125,180)">n</span><span class="token plain">] += </span><span class="token variable" style="color:rgb(28,125,180)">k</span><span class="token plain">[</span><span class="token variable" style="color:rgb(28,125,180)">m</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">n</span><span class="token plain">] * </span><span class="token variable" style="color:rgb(28,125,180)">x</span><span class="token plain">[</span><span class="token variable" style="color:rgb(28,125,180)">i</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">j</span><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-a-mask">Using a mask<a href="#using-a-mask" class="hash-link" aria-label="Direct link to Using a mask" title="Direct link to Using a mask">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="generalities">Generalities<a href="#generalities" class="hash-link" aria-label="Direct link to Generalities" title="Direct link to Generalities">â€‹</a></h3><p>If you want to propagate some values in a heterogeneous grid, you can use some mask to forbid some cells to propagate their values.</p><p>You can pass a matrix to the facet <code>mask</code>. All the values smaller than <code>-1</code> will not propagate, and all the values greater or equal to <code>-1</code> will propagate.</p><p>A simple way to use mask is by loading an image :</p><p><img loading="lazy" alt="Use of a mask to constrain the diffusion." src="/assets/images/simple_mask-3e0ac342e68682fee38a222962d0714d.png" width="1884" height="775" class="img_ev3q"></p><p>Note that when you use the <code>on</code> facet for the <code>diffuse</code> statement, you can choose only some cells, and not every cell. In fact, when you restrain the values to be diffuse, it is exactly the same process as if you were defining a mask.</p><p><img loading="lazy" alt="Constraint on the diffusion using filtering on cells." src="/assets/images/mask_with_on_facet-ff8091c334a116d3ae09e851feaacd40.png" width="1725" height="635" class="img_ev3q"></p><p>When your diffusion is combined with a mask, the default behavior is that the non-masked cells will diffuse their values in <strong>all</strong> existing cells (that means, even the masked cells !). To change this behavior, you can use the facet <code>avoid_mask</code>. In that case, the value which was supposed to be affected to the masked cell will be redistributed to the neighboring non-masked cells.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tips">Tips<a href="#tips" class="hash-link" aria-label="Direct link to Tips" title="Direct link to Tips">â€‹</a></h3><p>Masks can be used to simulate a lot of environments. Here are some ideas for your models:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="wall-blocking-the-diffusion">Wall blocking the diffusion<a href="#wall-blocking-the-diffusion" class="hash-link" aria-label="Direct link to Wall blocking the diffusion" title="Direct link to Wall blocking the diffusion">â€‹</a></h4><p>If you want to simulate a wall blocking a uniform diffusion, you can declare a second diffusion matrix that will be applied only on the cells where your wall will be. This diffusion matrix will &quot;push&quot; the values outside from himself, but conserving the values (the sum of the values of the diffusion still have to be equal to 1) :</p><div class="language-gaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#282A36;--prism-background-color:#FFFFFF"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#282A36"><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token plain">&lt;</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">float</span><span class="token plain">&gt; </span><span class="token variable" style="color:rgb(28,125,180)">mat_diff</span><span class="token plain"> &lt;- </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token punctuation">(</span><span class="token plain">[</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">            [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">            [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">            [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">                                </span><br></span><span class="token-line" style="color:#282A36"><span class="token plain"></span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token plain">&lt;</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">float</span><span class="token plain">&gt; </span><span class="token variable" style="color:rgb(28,125,180)">mat_diff_left_wall</span><span class="token plain"> &lt;- </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token punctuation">(</span><span class="token plain">[</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">            [</span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">            [</span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">4</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">            [</span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain"></span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">reflex</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">diff</span><span class="token plain"> { </span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffuse</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">var:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">on:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">cells</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">where</span><span class="token punctuation">(</span><span class="token keyword" style="color:rgb(0, 0, 0);font-style:italic">each</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">grid_x</span><span class="token plain">&gt;</span><span class="token number" style="color:rgb(125,125,125)">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">matrix:</span><span class="token variable" style="color:rgb(28,125,180)">mat_diff</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffuse</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">var:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">on:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">cells</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">where</span><span class="token punctuation">(</span><span class="token keyword" style="color:rgb(0, 0, 0);font-style:italic">each</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">grid_x</span><span class="token plain">=</span><span class="token number" style="color:rgb(125,125,125)">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">matrix:</span><span class="token variable" style="color:rgb(28,125,180)">mat_diff_left_wall</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="Diffusion limited by a wall, using a mask." src="/assets/images/wall_simulation-50de5f9444b8c0772534d12b60b8ab44.png" width="819" height="459" class="img_ev3q"></p><p>Note that almost the same result can be obtained by using the facet <code>avoid_mask</code>: the value of all masked cells will remain at 0, and the value which was supposed to be affected to the masked cell will be distributed to the neighboring cells. Notice that the results can be slightly different if you are using the <code>convolution</code> or the <code>dot_product</code> method: the algorithm of redistribution of the value to the neighboring cells is a bit different. We advise you to use the <code>dot_product</code> with the <code>avoid_mask</code> facet, the results are more accurate.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="wind-pushing-the-diffusion">Wind pushing the diffusion<a href="#wind-pushing-the-diffusion" class="hash-link" aria-label="Direct link to Wind pushing the diffusion" title="Direct link to Wind pushing the diffusion">â€‹</a></h4><p>Let&#x27;s simulate a uniform diffusion that is pushed by a wind from &quot;north&quot; everywhere in the grid. A wind from &quot;west&quot; as blowing at the top side of the grid. We will here have to build 2 matrices: one for the uniform diffusion, one for the &quot;north&quot; wind and one for the &quot;west&quot; wind. The sum of the values for the 2 matrices meant to simulate the wind will be equal to 0 (as it will be added to the diffusion matrix).</p><div class="language-gaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#282A36;--prism-background-color:#FFFFFF"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#282A36"><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token plain">&lt;</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">float</span><span class="token plain">&gt; </span><span class="token variable" style="color:rgb(28,125,180)">mat_diff</span><span class="token plain"> &lt;- </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token punctuation">(</span><span class="token plain">[</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">                                </span><br></span><span class="token-line" style="color:#282A36"><span class="token plain"></span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token plain">&lt;</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">float</span><span class="token plain">&gt; </span><span class="token variable" style="color:rgb(28,125,180)">mat_wind_from_west</span><span class="token plain"> &lt;- </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token punctuation">(</span><span class="token plain">[</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [-</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [-</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [-</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">                                </span><br></span><span class="token-line" style="color:#282A36"><span class="token plain"></span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token plain">&lt;</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">float</span><span class="token plain">&gt; </span><span class="token variable" style="color:rgb(28,125,180)">mat_wind_from_north</span><span class="token plain"> &lt;- </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token punctuation">(</span><span class="token plain">[</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [-</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token plain">-</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token plain">-</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain"></span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">reflex</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">diff</span><span class="token plain"> { </span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffuse</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">var:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">on:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">cells</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">matrix:</span><span class="token variable" style="color:rgb(28,125,180)">mat_diff</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffuse</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">var:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">on:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">cells</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">matrix:</span><span class="token variable" style="color:rgb(28,125,180)">mat_wind_from_north</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffuse</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">var:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">on:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">cells</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">where</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword" style="color:rgb(0, 0, 0);font-style:italic">each</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">grid_y</span><span class="token plain">&gt;=</span><span class="token number" style="color:rgb(125,125,125)">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">matrix:</span><span class="token variable" style="color:rgb(28,125,180)">mat_wind_from_west</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="Diffusion impacted with a wind." src="/assets/images/diffusion_with_wind-a43021bb9662a8e94618ba5f0b29610f.png" width="569" height="537" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="endless-world">Endless world<a href="#endless-world" class="hash-link" aria-label="Direct link to Endless world" title="Direct link to Endless world">â€‹</a></h4><p>Note that when your world is not a torus, it has the same effect as a <em>mask</em>, since all the values outside from the world cannot diffuse some values back :</p><p><img loading="lazy" alt="Comparison of diffusion with and without torus environment." src="/assets/images/uniform_diffusion_near_edge-79bc9dc01f56ac462fb9fe04115885d5.png" width="1268" height="638" class="img_ev3q"></p><p>You can &quot;fake&quot; the fact that your world is endless by adding a different diffusion for the cells with <code>grid_x=0</code> to have almost the same result :</p><p><img loading="lazy" alt="Attempt to fake torus environment with different matrices." src="/assets/images/uniform_diffusion_near_edge_with_mask-b6df4b4bc61baebdd5b92edb11c5bbff.png" width="1268" height="683" class="img_ev3q"></p><div class="language-gaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#282A36;--prism-background-color:#FFFFFF"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#282A36"><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token plain">&lt;</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">float</span><span class="token plain">&gt; </span><span class="token variable" style="color:rgb(28,125,180)">mat_diff</span><span class="token plain"> &lt;- </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token punctuation">(</span><span class="token plain">[</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">            [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">            [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">            [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">                                </span><br></span><span class="token-line" style="color:#282A36"><span class="token plain"></span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token plain">&lt;</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">float</span><span class="token plain">&gt; </span><span class="token variable" style="color:rgb(28,125,180)">mat_diff_upper_edge</span><span class="token plain"> &lt;- </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token punctuation">(</span><span class="token plain">[</span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">            [</span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">0.0</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">            [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">+</span><span class="token number" style="color:rgb(125,125,125)">7</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">+</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">+</span><span class="token number" style="color:rgb(125,125,125)">7</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">81</span><span class="token plain">]</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">            [</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token punctuation">,</span><span class="token number" style="color:rgb(125,125,125)">1</span><span class="token plain">/</span><span class="token number" style="color:rgb(125,125,125)">9</span><span class="token plain">]]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain"></span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">reflex</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">diff</span><span class="token plain"> { </span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffuse</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">var:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">on:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">cells</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">where</span><span class="token punctuation">(</span><span class="token keyword" style="color:rgb(0, 0, 0);font-style:italic">each</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">grid_y</span><span class="token plain">&gt;</span><span class="token number" style="color:rgb(125,125,125)">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">matrix:</span><span class="token variable" style="color:rgb(28,125,180)">mat_diff</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffuse</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">var:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">phero</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">on:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token variable" style="color:rgb(28,125,180)">cells</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">where</span><span class="token punctuation">(</span><span class="token keyword" style="color:rgb(0, 0, 0);font-style:italic">each</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">grid_y</span><span class="token plain">=</span><span class="token number" style="color:rgb(125,125,125)">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token facet" style="color:rgb(154,72,71)">matrix:</span><span class="token variable" style="color:rgb(28,125,180)">mat_diff_upper_edge</span><span class="token punctuation">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pseudo-code">Pseudo-code<a href="#pseudo-code" class="hash-link" aria-label="Direct link to Pseudo-code" title="Direct link to Pseudo-code">â€‹</a></h2><p><em>This section is more for a better understanding of the source code.</em></p><p>Here is the pseudo-code for the computation of diffusion :</p><p>1) : Execute the statement <code>diffuse</code>, store the diffusions in a map (from class <em>DiffusionStatement</em> to class <em>GridDiffuser</em>) :</p><div class="language-gaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#282A36;--prism-background-color:#FFFFFF"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#282A36"><span class="token plain">- </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">Get</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">all</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">facet</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">- </span><span class="token variable" style="color:rgb(28,125,180)">Compute</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;real&quot;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">mask</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">from</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">facet</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;mask:&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">and</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">facet</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;on:&quot;</span><span class="token punctuation">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">  - </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">If</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">no</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">value</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">for</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;mask:&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">and</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;on:&quot;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">all</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">grid</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">mask</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">is</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">equal</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">to</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">null</span><span class="token punctuation">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">- </span><span class="token variable" style="color:rgb(28,125,180)">Compute</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token type_statement" style="color:rgb(127,0,85);font-style:bold">matrix </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">of</span><span class="token plain"> </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffusion</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">  - </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">If</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">no</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">value</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">for</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;matrix:&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">compute</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">with</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;nb_neighbors&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;is_gradient&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;proportion&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;propagation&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;variation&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;range&quot;</span><span class="token punctuation">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">  - </span><span class="token variable" style="color:rgb(28,125,180)">Then</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">compute</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token type_statement" style="color:rgb(127,0,85);font-style:bold">matrix </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">of</span><span class="token plain"> </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffusion</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">with</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;cycle_length&quot;</span><span class="token punctuation">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">- </span><span class="token variable" style="color:rgb(28,125,180)">Store</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffusion</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">properties</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">in</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">a</span><span class="token plain"> </span><span class="token type_statement" style="color:rgb(127,0,85);font-style:bold">map</span><br></span><span class="token-line" style="color:#282A36"><span class="token type_statement" style="color:rgb(127,0,85);font-style:bold"></span><span class="token plain">  - </span><span class="token type_statement" style="color:rgb(127,0,85);font-style:bold">Map </span><span class="token punctuation">:</span><span class="token plain"> [</span><span class="token string" style="color:rgb(116,167,251)">&quot;method_diffu&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;is_gradient&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;matrix&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;mask&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;min_value&quot;</span><span class="token plain">] </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">is</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">value</span><span class="token punctuation">,</span><span class="token plain"> [</span><span class="token string" style="color:rgb(116,167,251)">&quot;var_diffu&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;grid_name&quot;</span><span class="token plain">] </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">is</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">key</span><span class="token punctuation">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">  - </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">If</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">key</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">exists</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">in</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">map</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">try</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">to</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;mix&quot;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">diffusions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    - </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">If</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;method_diffu&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;mask&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">and</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;is_gradient&quot;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">equal</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">for</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token number" style="color:rgb(125,125,125)">2</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">diffusions</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">mix</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffusion</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">matrix</span><span class="token punctuation">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2) : At the end of the step, execute the diffusions (class <em>GridDiffuser</em>) :</p><div class="language-gaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#282A36;--prism-background-color:#FFFFFF"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#282A36"><span class="token plain">- </span><span class="token variable" style="color:rgb(28,125,180)">For</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 0);font-style:italic">each</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">key</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">of</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">map</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">  - </span><span class="token variable" style="color:rgb(28,125,180)">Load</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">couple</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;var_diffu&quot;</span><span class="token plain"> / </span><span class="token string" style="color:rgb(116,167,251)">&quot;grid_name&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">  - </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">Build</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;output&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">and</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;input&quot;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">array</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">with</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">dimension</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">of</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">grid</span><span class="token punctuation">.</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">  - </span><span class="token variable" style="color:rgb(28,125,180)">Initialize</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;output&quot;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">array</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">with</span><span class="token plain"> -</span><span class="token variable" style="color:rgb(28,125,180)">Double</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">MAX_VALUE</span><span class="token punctuation">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">  - </span><span class="token variable" style="color:rgb(28,125,180)">For</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 0);font-style:italic">each</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">value</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">of</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token type_statement" style="color:rgb(127,0,85);font-style:bold">map </span><span class="token variable" style="color:rgb(28,125,180)">for</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">that</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">key</span><span class="token punctuation">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    - </span><span class="token variable" style="color:rgb(28,125,180)">Load</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">all</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">properties</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;method_diffu&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;is_gradient&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;matrix&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;mask&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(116,167,251)">&quot;min_value&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    - </span><span class="token variable" style="color:rgb(28,125,180)">Compute</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">      - </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">If</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">cell</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">is</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">not</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">masked</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">if</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">value</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">of</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">input</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">is</span><span class="token plain"> &gt; </span><span class="token variable" style="color:rgb(28,125,180)">min_value</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffuse</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">to</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">neighbors</span><span class="token punctuation">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        - </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">If</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">value</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">of</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">cell</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">is</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">equal</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">to</span><span class="token plain"> -</span><span class="token variable" style="color:rgb(28,125,180)">Double</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">MAX_VALUE</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">remplace</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">it</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">by</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">input</span><span class="token plain">[</span><span class="token variable" style="color:rgb(28,125,180)">idx</span><span class="token plain">] * </span><span class="token variable" style="color:rgb(28,125,180)">matDiffu</span><span class="token plain">[</span><span class="token variable" style="color:rgb(28,125,180)">i</span><span class="token plain">][</span><span class="token variable" style="color:rgb(28,125,180)">j</span><span class="token plain">]</span><span class="token punctuation">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">        - </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">Else</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">do</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">computation</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">gradient</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">or</span><span class="token plain"> </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffusion</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">    - </span><span class="token variable" style="color:rgb(28,125,180)">Finish</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">diffusion</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#282A36"><span class="token plain">      - </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">If</span><span class="token plain"> </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">output</span><span class="token plain">[</span><span class="token variable" style="color:rgb(28,125,180)">idx</span><span class="token plain">] &gt; -</span><span class="token variable" style="color:rgb(28,125,180)">Double</span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">.</span><span class="token variable" style="color:rgb(28,125,180)">MAX_VALUE</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token statement" style="color:rgb(127,0, 85);font-style:bold">write</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">new</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">value</span><span class="token plain"> </span><span class="token operator" style="color:rgb(46,93,78);font-style:bold">in</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">the</span><span class="token plain"> </span><span class="token variable" style="color:rgb(28,125,180)">cell</span><span class="token punctuation">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/gama-platform/gama/wiki/Diffusion/_edit" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/wiki/ManipulateOSMDatas"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Manipulate OSM Datas</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/wiki/UsingDatabase"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Using Database Access</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#index" class="table-of-contents__link toc-highlight">Index</a></li><li><a href="#diffuse-statement" class="table-of-contents__link toc-highlight">Diffuse statement</a></li><li><a href="#diffusion-with-matrix" class="table-of-contents__link toc-highlight">Diffusion with matrix</a><ul><li><a href="#diffusion-matrix" class="table-of-contents__link toc-highlight">Diffusion matrix</a></li><li><a href="#gradient-matrix" class="table-of-contents__link toc-highlight">Gradient matrix</a></li><li><a href="#compute-multiple-propagations-at-the-same-step" class="table-of-contents__link toc-highlight">Compute multiple propagations at the same step</a></li><li><a href="#executing-several-diffusion-matrix" class="table-of-contents__link toc-highlight">Executing several diffusion matrix</a></li></ul></li><li><a href="#diffusion-with-parameters" class="table-of-contents__link toc-highlight">Diffusion with parameters</a></li><li><a href="#computation-methods" class="table-of-contents__link toc-highlight">Computation methods</a><ul><li><a href="#convolution" class="table-of-contents__link toc-highlight">Convolution</a></li><li><a href="#dot-product" class="table-of-contents__link toc-highlight">Dot Product</a></li></ul></li><li><a href="#using-a-mask" class="table-of-contents__link toc-highlight">Using a mask</a><ul><li><a href="#generalities" class="table-of-contents__link toc-highlight">Generalities</a></li><li><a href="#tips" class="table-of-contents__link toc-highlight">Tips</a></li></ul></li><li><a href="#pseudo-code" class="table-of-contents__link toc-highlight">Pseudo-code</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="https://github.com/gama-platform" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> Github <i class="fa fa-arrow-up-right-from-square"></i></a></li><li class="footer__item"><a class="footer__link-item" href="https://www.facebook.com/GamaPlatform/" target="_blank" rel="noopener noreferrer"><i class="fab fa-facebook"></i> Facebook <i class="fa fa-arrow-up-right-from-square"></i></a></li><li class="footer__item"><a class="footer__link-item" href="https://www.linkedin.com/company/gama-platform" target="_blank" rel="noopener noreferrer"><i class="fab fa-linkedin"></i> LinkedIn <i class="fa fa-arrow-up-right-from-square"></i></a></li><li class="footer__item"><a class="footer__link-item" href="https://www.youtube.com/channel/UCWJ1kWGDDI-9u2f2uD0gcaQ" target="_blank" rel="noopener noreferrer"><i class="fab fa-youtube"></i> Youtube <i class="fa fa-arrow-up-right-from-square"></i></a></li><li class="footer__item"><a class="footer__link-item" href="https://gama-platform.org/blog/rss.xml" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss"></i> Blog RSS <i class="fa fa-arrow-up-right-from-square"></i></a></li></ul></div><div class="col footer__col"><div class="footer__title">Mailing list</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="https://groups.google.com/forum/#!forum/gama-platform" target="_blank"><i class="fas fa-envelope"></i> For Users<br>gama-platform@googlegroups.com</a></li><li class="footer__item"><a class="footer__link-item" href="https://groups.google.com/forum/#!forum/gama-dev" target="_blank"><i class="fas fa-envelope"></i> For Developers<br>gama-dev@googlegroups.com</a></li></ul></div><div class="col footer__col"><div class="footer__title">Licence</div><ul class="footer__items clean-list"><li class="footer__item">
                  <p>
                    Permission is granted to copy, distribute and/or modify this document under the terms of the GNU Free Documentation License, Version 1.3 or any later version published by the Free Software Foundation; with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
                  </p>
                </li><li class="footer__item">
                  <p>A copy of the license is included <a href="https://github.com/gama-platform/gama/wiki/LICENSE.md" style="display:initial">here</a>, in the repository of the wiki content.</p>
                </li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/gama-logo.png" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/gama-logo.png" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></div><div class="footer__copyright">Copyright (C) - 2023 GAMA Platform.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.f853084d.js"></script>
<script src="/assets/js/main.4e25c91d.js"></script>
</body>
</html>