"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[54282],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>u});var i=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function r(e,n){if(null==e)return{};var t,i,a=function(e,n){if(null==e)return{};var t,i,a={},o=Object.keys(e);for(i=0;i<o.length;i++)t=o[i],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)t=o[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var p=i.createContext({}),s=function(e){var n=i.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},d=function(e){var n=s(e.components);return i.createElement(p.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},f=i.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,p=e.parentName,d=r(e,["components","mdxType","originalType","parentName"]),f=s(t),u=a,m=f["".concat(p,".").concat(u)]||f[u]||c[u]||o;return t?i.createElement(m,l(l({ref:n},d),{},{components:t})):i.createElement(m,l({ref:n},d))}));function u(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,l=new Array(o);l[0]=f;var r={};for(var p in n)hasOwnProperty.call(n,p)&&(r[p]=n[p]);r.originalType=e,r.mdxType="string"==typeof e?e:a,l[1]=r;for(var s=2;s<o;s++)l[s]=t[s];return i.createElement.apply(null,l)}return i.createElement.apply(null,t)}f.displayName="MDXCreateElement"},59280:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>p,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var i=t(87462),a=t(63366),o=(t(67294),t(3905)),l=["components"],r={title:"7. Differential Equations"},p=void 0,s={unversionedId:"IncrementalModel_step7",id:"version-1.8.1/IncrementalModel_step7",title:"7. Differential Equations",description:"This step illustrates how to use differential equations.",source:"@site/versioned_docs/version-1.8.1/IncrementalModel_step7.md",sourceDirName:".",slug:"/IncrementalModel_step7",permalink:"/wiki/1.8.1/IncrementalModel_step7",draft:!1,editUrl:"https://github.com/gama-platform/gama/wiki/IncrementalModel_step7/_edit",tags:[],version:"1.8.1",frontMatter:{title:"7. Differential Equations"},sidebar:"tuto",previous:{title:"6. Multi-Level",permalink:"/wiki/1.8.1/IncrementalModel_step6"},next:{title:"Luneray's flu",permalink:"/wiki/1.8.1/LuneraysFlu"}},d={},c=[{value:"Formulation",id:"formulation",level:2},{value:"Model Definition",id:"model-definition",level:2},{value:"global variables",id:"global-variables",level:3},{value:"building",id:"building",level:3},{value:"Complete Model",id:"complete-model",level:2}],f={toc:c};function u(e){var n=e.components,r=(0,a.Z)(e,l);return(0,o.kt)("wrapper",(0,i.Z)({},f,r,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"This step illustrates how to use differential equations."),(0,o.kt)("h2",{id:"formulation"},"Formulation"),(0,o.kt)("p",null,"We are interested in the spreading of the disease inside the buildings. In order to model it, we will use ",(0,o.kt)("a",{parentName:"p",href:"Equations"},"differential equations"),". So, we will need to:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Add two global variables to define the building epidemic properties (",(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"strong"},"beta")),") and numerical integration parameter (",(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"strong"},"h")),")."),(0,o.kt)("li",{parentName:"ul"},"Add new variables for the buildings (",(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"strong"},"I")),", ",(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"strong"},"S")),", ",(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"strong"},"T")),", ",(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"strong"},"t")),", ",(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"strong"},"I_to1")),") to manage epidemic;"),(0,o.kt)("li",{parentName:"ul"},"Define differential equations for disease spreading inside buildings."),(0,o.kt)("li",{parentName:"ul"},"Add one behavior for buildings for the spreading of the disease.")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Incremental model 7: final step introducing a mathematical model for disease spread in buildings.",src:t(52562).Z,width:"1612",height:"831"})),(0,o.kt)("h2",{id:"model-definition"},"Model Definition"),(0,o.kt)("h3",{id:"global-variables"},"global variables"),(0,o.kt)("p",null,"We define two new global variables used in the disease spreading dynamic inside the buildings: (i) ",(0,o.kt)("inlineCode",{parentName:"p"},"beta")," is the contamination rate,  and ",(0,o.kt)("inlineCode",{parentName:"p"},"h")," is the integration step (used in the ",(0,o.kt)("inlineCode",{parentName:"p"},"solve")," statement)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"global  {\n    ...\n    float beta <- 0.01;\n    float h <- 0.1;\n    ...\n}\n")),(0,o.kt)("h3",{id:"building"},"building"),(0,o.kt)("p",null,"In order to define the disease spread dynamics, we define several variables that will be used by the differential equations:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"strong"},"I")),": float, number of people infected in the building."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"strong"},"S")),": float, number of people not infected in the building."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"strong"},"T")),": float, the total number of people in the building."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"strong"},"t")),": float, the current time of the equation system integration."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"strong"},"I_to1")),": float, the remaining number of people infected (float number lower between 0 and 1 according to the differential equations).")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"species building {\n    ...\n    float I;\n    float S;\n    float T;\n    float t;   \n    float I_to1; \n    ...\n}\n")),(0,o.kt)("p",null,"Then, we define the differential equations system that will be used for the disease spreading dynamic. Note that to define a differential equation system we use the block ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"equation"))," + name. These equations are the classic ones used by SI mathematical models."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"species building {\n    ....\n    equation SI{ \n    diff(S,t) = (- beta * S * I / T) ;\n    diff(I,t) = (  beta * S * I / T) ;\n    }\n    ...\n}\n")),(0,o.kt)("p",null,"At last, we define a new reflex for the building called ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"epidemic"))," that will be activated only when there is someone inside the building. This reflex first computes the number of people inside the building (",(0,o.kt)("inlineCode",{parentName:"p"},"T"),"), then the number of not infected people (",(0,o.kt)("inlineCode",{parentName:"p"},"S"),") and finally the number of infected ones (",(0,o.kt)("inlineCode",{parentName:"p"},"I"),")."),(0,o.kt)("p",null,"If there is at least one people infected and one people not infected, the differential equations is integrated (according to the integration step value ",(0,o.kt)("inlineCode",{parentName:"p"},"h"),") with the method Runge-Kutta 4 to compute the new value of infected people. We then sum the old value of ",(0,o.kt)("inlineCode",{parentName:"p"},"I_to1")," with the number of people newly infected (this value is a float and not an integer). Finally, we cast this value as an integer, ask the corresponding number of not infected people to become infected, and decrement this integer value to ",(0,o.kt)("inlineCode",{parentName:"p"},"I\\_to1"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"species building {\n    ...\n    reflex epidemic when: nb_total > 0 {\n    T <- float(nb_total);\n    S <- float(nb_total - nb_infected);\n    I <- T - S;\n    float I0 <- I;\n    if (I > 0 and S > 0) {\n        solve SI method: #rk4 step_size: h;\n        I_to1 <- I_to1 + (I - I0);\n        int I_int <- min([int(S), int(I_to1)]);\n        I_to1 <- I_to1 - I_int;\n        ask (I_int among (people_in_building where (!each.is_infected))) {\n        is_infected <- true;\n        }\n    }\n    }\n    ...\n}\n")),(0,o.kt)("h2",{id:"complete-model"},"Complete Model"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'/**\n* Name: Differential Equation\n* Author: GAMA Team\n* Description: 7th part of the tutorial : Incremental Model\n* Tags: tutorial, chart, graph, 3d, light, multi-Level, equation\n*/\nmodel model7\n\nglobal {\n    int nb_people <- 500;\n    float agent_speed <- 5.0 #km / #h;\n    float step <- 1 #minutes;\n    float infection_distance <- 2.0 #m;\n    float proba_infection <- 0.05;\n    int nb_infected_init <- 5;\n    file roads_shapefile <- file("../includes/road.shp");\n    file buildings_shapefile <- file("../includes/building.shp");\n    geometry shape <- envelope(roads_shapefile);\n    graph road_network;\n    float staying_coeff update: 10.0 ^ (1 + min([abs(current_date.hour - 9), abs(current_date.hour - 12), abs(current_date.hour - 18)]));\n    float beta <- 0.01;\n    float h <- 0.1;\n    list<people_in_building> list_people_in_buildings update: (building accumulate each.people_in_building);\n    int nb_people_infected <- nb_infected_init update: (people + list_people_in_buildings) count (each.is_infected);\n    int nb_people_not_infected <- nb_people - nb_infected_init update: nb_people - nb_people_infected;\n    bool is_night <- true update: current_date.hour < 7 or current_date.hour > 20;\n    float infected_rate update: nb_people_infected / nb_people;\n\n    init {\n    create road from: roads_shapefile;\n    road_network <- as_edge_graph(road);\n    create building from: buildings_shapefile;\n    create people number: nb_people {\n        speed <- agent_speed;\n        building bd <- one_of(building);\n        location <- any_location_in(bd);\n    }\n\n    ask nb_infected_init among people {\n        is_infected <- true;\n    }\n    }\n\n    reflex end_simulation when: infected_rate = 1.0 {\n    do pause;\n    }\n}\n\nspecies people skills: [moving] {\n    bool is_infected <- false;\n    point target;\n    int staying_counter;\n\n    reflex move when: target != nil {\n    do goto target: target on: road_network;\n    if (location = target) {\n        target <- any_location_in(one_of(building));\n        target <- nil;\n        staying_counter <- 0;\n    }\n    }\n\n    reflex infect when: is_infected {\n    ask people at_distance infection_distance {\n        if flip(proba_infection) {\n        is_infected <- true;\n        }\n    }\n    }\n\n    aspect circle {\n    draw circle(5) color: is_infected ? #red : #green;\n    }\n\n    aspect sphere3D {\n    draw sphere(3) at: {location.x, location.y, location.z + 3} color: is_infected ? #red : #green;\n    }\n}\n\nspecies road {\n    geometry display_shape <- shape + 2.0;\n\n    aspect default {\n    draw display_shape color: #black depth: 3.0;\n    }\n}\n\nspecies building {\n    int nb_infected <- 0 update: self.people_in_building count each.is_infected;\n    int nb_total <- 0 update: length(self.people_in_building);\n    float height <- rnd(10 #m, 20 #m);\n    float I;\n    float S;\n    float T;\n    float t;\n    float I_to1;\n\n    species people_in_building parent: people schedules: [] { }\n\n    reflex let_people_leave {\n    ask self.people_in_building {\n        staying_counter <- staying_counter + 1;\n    }\n\n    release people_in_building where (flip((each).staying_counter / staying_coeff)) as: people in: world {\n        target <- any_location_in(one_of(building));\n    }\n    }\n\n    reflex let_people_enter {\n    capture (people inside self) where (each.target = nil) as: people_in_building;\n    }\n\n    equation SI {\n    diff(S, t) = (-beta * S * I / T);\n    diff(I, t) = (beta * S * I / T);\n    }\n\n    reflex epidemic when: nb_total > 0 {\n    T <- float(nb_total);\n    S <- float(nb_total - nb_infected);\n    I <- T - S;\n    float I0 <- I;\n    if (I > 0 and S > 0) {\n        solve SI method: #rk4 step_size: h;\n        I_to1 <- I_to1 + (I - I0);\n        int I_int <- min([int(S), int(I_to1)]);\n        I_to1 <- I_to1 - I_int;\n        ask (I_int among (people_in_building where (!each.is_infected))) {\n        is_infected <- true;\n        }\n    }\n    }\n\n    aspect default {\n    draw shape color: nb_total = 0 ? #gray : (float(nb_infected) / nb_total > 0.5 ? #red : #green) border: #black depth: height;\n    }\n}\n\nexperiment main_experiment type: gui {\n    parameter "Infection distance" var: infection_distance;\n    parameter "Proba infection" var: proba_infection min: 0.0 max: 1.0;\n    parameter "Nb people infected at init" var: nb_infected_init;\n    output {\n    monitor "Current hour" value: current_date.hour;\n    monitor "Infected people rate" value: infected_rate;\n    display map_3D type: opengl {\n        light 1 color: (is_night ? 50 : 255);\n        image "../includes/soil.jpg";\n        species road;\n        species people aspect: sphere3D;\n        species building transparency: 0.5;\n    }\n    display chart refresh: every(10 #cycles) {\n        chart "Disease spreading" type: series {\n        data "susceptible" value: nb_people_not_infected color: #green marker: false;\n        data "infected" value: nb_people_infected color: #red marker: false;\n        }\n    }\n    }\n}\n')))}u.isMDXComponent=!0},52562:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/incremental_model-81a4bac86041bbb55c67c907acae6bc7.jpg"}}]);