# .travis.yml
language: node_js
dist: trusty
node_js:
  - '8'
branches:
  only:
    - sources
cache:
  yarn: true
addons:
  sonarcloud:
    organization: "gama-platform"
    token:
      secure: "mgaj4PaR6gipcTGRQ3vjesY8YfLL29cj7y1qMWuPSyJqYWa+QUyv6Q/LBiJ5j8fh5G2oUAPGiVPfOTYMAvGsBbIXOGN+kUtV062ZKOqHrWkIiqQLDhwq7L9tZHiZ51vTlNaeRySrDmW7tBLh2OqCWDd9/BqX6pWJ8o2C6Ek8dD0kXTEb3fiELLmZT7sRPmz894Isy6Zy8LUM4xGV9rJ9hN3NmeaO8J/cfn4sUPhT5J1CZ39KGmuChA+wehmYz4nzLJyPcwbZGCpKanJ2W9NDXS8bgMMiH7df+wnubxbaOzCO9B6Q3I40oZtabjSZupkssfUdaZ8IDmCmBV8xAyQm+fC0m5PM59ytHIu+jHQ0odNK3YUkN/TmGwl0Qi7KN+zQTgnpx1oDPEcZI103+ENPRvi2GnVwk/N8JLueRqV/MLaZHvWwVSysDnXByDyLsoI2mN4ynrjhXVxHVBgwJDvxFbnSiUtlPnx3tZNw+XBTAdXpYdpSSTJDo6m3WQipT6AI/BNNgMrxXW9mJeqqKLCQZ0jyUu09KaExMQGDYN45QxEaJi4X097oZJijyHmO6oYwGH9RzW0Jlvgqu4mjn9fzPmhS5GOEDrYJvdugUvCDYWvblmVJq46y+BRmx0ljw8orw6BhGiMGxQFxCZ0M9uAaJ9D91Zwfa1l5CgE+bcsUNEU="
      
before_script:
  # the following command line builds the project, runs the tests with coverage and then execute the SonarCloud analysis
  - sonar-scanner -X -Dsonar.branch.name=sources -Dsonar.projectKey=gama-platform_gama-platform.github.io -Dsonar.projectName=gama-platform.github.io -Dsonar.projectVersion=1.0.0 -Dsonar.sources=. -Dsonar.language=js -Dsonar.host.url=https://sonarcloud.io

  #  Setup
  - git config --global user.name "${GH_NAME}"
  - git config --global user.email "${GH_EMAIL}"
  - echo "machine github.com login ${GH_NAME} password ${BOT_TOKEN}" > ~/.netrc

script:  
  #  Get new wiki
  - git clone https://github.com/gama-platform/gama.wiki.git
  
  #  Reorganise folders to be more Docusaurus-friendly
  - sh ./script/unstructurize.sh
  - sh ./script/link_fixer.sh
  - sed -i '/^$/d' './docs/_Sidebar.md' # Remove blank line
  - php script/sidebarCopy.php
  - php script/sidebarSearch.php
  - sh script/autoHeader.sh

  #  Compile website
  - cd website && yarn install && GIT_USER="${GH_NAME}" yarn run publish-gh-pages

